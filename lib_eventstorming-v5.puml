!global $ICON_FORMAT="png"
!global $TEXT_WIDTH_MAX=200
!global $MSG_WIDTH_MAX=150
!global $FONT_SIZE_XS=10
!global $FONT_SIZE_SM=12
!global $FONT_SIZE_MD=16
!global $FONT_SIZE_LG=20
!global $FONT_COLOR="#6f4545ff"
!global $FONT_COLOR_LIGHT="#757575"
!global $flowCounter = 0

' Smart Flow Counters
!global $studentCounter = 0
!global $courseCounter = 0
!global $userCounter = 0
!global $orderCounter = 0
!global $packageCounter = 0
!global $classCounter = 0
!global $policyCounter = 0
!global $serviceCounter = 0

!function $randomColor()
!$colors = "#8B0000,#A52A2A,#B22222,#DC143C,#FF0000,#FF6347,#FF4500,#FF8C00,#FFA500,#FFD700,#B8860B,#DAA520,#EEE8AA,#BDB76B,#F0E68C,#808000,#556B2F,#6B8E23,#9ACD32,#00FF00,#32CD32,#00FF32,#00FA9A,#90EE90,#98FB98,#8FBC8F,#00FF7F,#00C957,#3CB371,#2E8B57,#228B22,#008000,#006400,#9ACD32,#6B8E23,#808000,#556B2F,#66CDAA,#8FBC8F,#20B2AA,#008B8B,#008080,#5F9EA0,#4682B4,#6495ED,#00CED1,#00BFFF,#87CEEB,#87CEFA,#00BFFF,#ADD8E6,#B0E0E6,#87CEEB,#4169E1,#0000FF,#0000CD,#00008B,#000080,#191970,#483D8B,#6A5ACD,#7B68EE,#9370DB,#8A2BE2,#9400D3,#9932CC,#BA55D3,#DA70D6,#EE82EE,#DDA0DD,#C71585,#FF1493,#FF69B4,#FFB6C1,#FFC0CB,#F08080,#CD5C5C,#A0522D,#8B4513,#D2691E,#CD853F,#F4A460,#DEB887,#D2B48C,#BC8F8F,#F5DEB3,#FFEBCD,#FFE4E1,#FFDEAD,#F5F5DC,#FDF5E6,#FFFAF0,#FFFFF0,#FAEBD7,#FAF0E6,#FFF8DC,#FFFFE0,#2F4F4F,#696969,#708090,#778899,#B0C4DE,#E6E6FA,#FFFAF0,#F0F8FF,#F5F5F5,#DCDCDC,#D3D3D3,#C0C0C0,#A9A9A9,#808080,#1F1F1F,#2F2F2F,#3F3F3F,#4F4F4F,#5F5F5F,#6F6F6F,#7F7F7F,#8F8F8F,#9F9F9F,#000000,#0F0F0F,#1A1A1A,#2A2A2A,#3A3A3A,#4A4A4A,#5A5A5A,#6A6A6A,#7A7A7A,#8A8A8A,#9A9A9A"
!$colorArray = %splitstr($colors, ",")
!$index = %random(0, %size($colorArray)-1)
!return $colorArray[$index]
!endfunction

!function $getNextCounter($aggregateType)
  !if ($aggregateType == "Student")
    !global $studentCounter = $studentCounter + 1
    !return $studentCounter
  !elseif ($aggregateType == "Course")
    !global $courseCounter = $courseCounter + 1
    !return $courseCounter
  !elseif ($aggregateType == "User")
    !global $userCounter = $userCounter + 1
    !return $userCounter
  !elseif ($aggregateType == "Order")
    !global $orderCounter = $orderCounter + 1
    !return $orderCounter
  !elseif ($aggregateType == "Package")
    !global $packageCounter = $packageCounter + 1
    !return $packageCounter
  !elseif ($aggregateType == "Class")
    !global $classCounter = $classCounter + 1
    !return $classCounter
  !elseif ($aggregateType == "Policy")
    !global $policyCounter = $policyCounter + 1
    !return $policyCounter
  !elseif ($aggregateType == "Service")
    !global $serviceCounter = $serviceCounter + 1
    !return $serviceCounter
  !else
    !return 1
  !endif
!endfunction

!function $createContextualAggregate($aggregateType, $command)
  !$counter = $getNextCounter($aggregateType)
  
  !$context = $aggregateType
  !if (%strpos($command, "Package") >= 0)
    !$context = $aggregateType + "Pkg"
  !elseif (%strpos($command, "Class") >= 0)
    !$context = $aggregateType + "Cls"  
  !elseif (%strpos($command, "Delete") >= 0)
    !$context = $aggregateType + "Del"
  !elseif (%strpos($command, "Create") >= 0)
    !$context = $aggregateType + "Crt"
  !elseif (%strpos($command, "Update") >= 0)
    !$context = $aggregateType + "Upd"
  !endif
  
  !$aggregateName = $context + $counter
  Aggregate($aggregateName, $aggregateType)
  !return $aggregateName
!endfunction

!procedure $SmartFlow($from, $through, $to="", $to2="", $to3="", $to4="", $to5="")
!$flowCounter = $flowCounter + 1
!$color = $randomColor()

!$actualThrough = $createContextualAggregate($through, $from)

$from -[$color]-> $actualThrough : $flowCounter

!if ($to != "")
$actualThrough -[$color]-> $to : $flowCounter
!endif
!if ($to2 != "")
$actualThrough -[$color]-> $to2 : $flowCounter
!endif
!if ($to3 != "")
$actualThrough -[$color]-> $to3 : $flowCounter
!endif
!if ($to4 != "")
$actualThrough -[$color]-> $to4 : $flowCounter
!endif
!if ($to5 != "")
$actualThrough -[$color]-> $to5 : $flowCounter
!endif
!endprocedure

!procedure $SmartFlow2($from, $through, $evt1="", $evt2="", $evt3="")
!$flowCounter = $flowCounter + 1
!$color = $randomColor()

!$actualThrough = $createContextualAggregate($through, $from)

$from -[$color]-> $actualThrough : $flowCounter

!if ($evt1 != "")
$actualThrough -[$color]-> $evt1 : $flowCounter
!endif
!if ($evt2 != "")
$actualThrough -[$color]-> $evt2 : $flowCounter
!endif
!if ($evt3 != "")
$actualThrough -[$color]-> $evt3 : $flowCounter
!endif
!endprocedure

!procedure $SmartFlow3($from, $through, $to1, $evt1="", $evt2="", $evt3="")
!$flowCounter = $flowCounter + 1
!$color = $randomColor()

!$actualThrough = $createContextualAggregate($through, $from)

$from -[$color]-> $actualThrough : $flowCounter
$actualThrough -[$color]-> $to1 : $flowCounter

!if ($evt1 != "")
$to1 -[$color]-> $evt1 : $flowCounter
!endif
!if ($evt2 != "")
$to1 -[$color]-> $evt2 : $flowCounter
!endif
!if ($evt3 != "")
$to1 -[$color]-> $evt3 : $flowCounter
!endif
!endprocedure

!function $processElement($element, $command)
  !if ($element == "Student" || $element == "Course" || $element == "User" || $element == "Package" || $element == "Class")
    !return $createContextualAggregate($element, $command)
  !else
    !return $element
  !endif
!endfunction

!procedure $SmartFlow4($from, $through, $to1, $to2, $evt1="", $evt2="", $evt3="")
!$flowCounter = $flowCounter + 1
!$color = $randomColor()

!$actualThrough = $processElement($through, $from)
!$actualTo1 = $processElement($to1, $from)
!$actualTo2 = $processElement($to2, $from)

$from -[$color]-> $actualThrough : $flowCounter
$actualThrough -[$color]-> $actualTo1 : $flowCounter
$actualTo1 -[$color]-> $actualTo2 : $flowCounter

!if ($evt1 != "")
$actualTo2 -[$color]-> $evt1 : $flowCounter
!endif
!if ($evt2 != "")
$actualTo2 -[$color]-> $evt2 : $flowCounter
!endif
!if ($evt3 != "")
$actualTo2 -[$color]-> $evt3 : $flowCounter
!endif
!endprocedure

!procedure $SmartFlow3($from, $through, $to1, $evt1="", $evt2="", $evt3="")
!$flowCounter = $flowCounter + 1
!$color = $randomColor()

!$actualThrough = $processElement($through, $from)
!$actualTo1 = $processElement($to1, $from)

$from -[$color]-> $actualThrough : $flowCounter
$actualThrough -[$color]-> $actualTo1 : $flowCounter

!if ($evt1 != "")
$actualTo1 -[$color]-> $evt1 : $flowCounter
!endif
!if ($evt2 != "")
$actualTo1 -[$color]-> $evt2 : $flowCounter
!endif
!if ($evt3 != "")
$actualTo1 -[$color]-> $evt3 : $flowCounter
!endif
!endprocedure

!procedure $SmartFlow5($from, $through, $to1, $to2, $to3, $evt1="", $evt2="", $evt3="")
!$flowCounter = $flowCounter + 1
!$color = $randomColor()

!$actualThrough = $processElement($through, $from)
!$actualTo1 = $processElement($to1, $from)
!$actualTo2 = $processElement($to2, $from)
!$actualTo3 = $processElement($to3, $from)

$from -[$color]-> $actualThrough : $flowCounter
$actualThrough -[$color]-> $actualTo1 : $flowCounter
$actualTo1 -[$color]-> $actualTo2 : $flowCounter
$actualTo2 -[$color]-> $actualTo3 : $flowCounter

!if ($evt1 != "")
$actualTo3 -[$color]-> $evt1 : $flowCounter
!endif
!if ($evt2 != "")
$actualTo3 -[$color]-> $evt2 : $flowCounter
!endif
!if ($evt3 != "")
$actualTo3 -[$color]-> $evt3 : $flowCounter
!endif
!endprocedure

!procedure $SmartFlow6($from, $through, $to1, $to2, $to3, $to4, $evt1="", $evt2="", $evt3="")
!$flowCounter = $flowCounter + 1
!$color = $randomColor()

!$actualThrough = $processElement($through, $from)
!$actualTo1 = $processElement($to1, $from)
!$actualTo2 = $processElement($to2, $from)
!$actualTo3 = $processElement($to3, $from)
!$actualTo4 = $processElement($to4, $from)

$from -[$color]-> $actualThrough
$actualThrough -[$color]-> $actualTo1
$actualTo1 -[$color]-> $actualTo2
$actualTo2 -[$color]-> $actualTo3
$actualTo3 -[$color]-> $actualTo4

!if ($evt1 != "")
$actualTo4 -[$color]-> $evt1 : $flowCounter
!endif
!if ($evt2 != "")
$actualTo4 -[$color]-> $evt2 : $flowCounter
!endif
!if ($evt3 != "")
$actualTo4 -[$color]-> $evt3 : $flowCounter
!endif
!endprocedure

!procedure EsEntity($shape, $stereotype, $id, $label="")
  !if ($label != "")
    $shape "$label" as $id <<$stereotype>>
  !else
    $shape $id <<$stereotype>>
  !endif
!endprocedure

show stereotype

skinparam defaultTextAlignment center
skinparam wrapWidth 200
skinparam maxMessageSize 150

skinparam Arrow {
    Color $FONT_COLOR
    FontColor $FONT_COLOR
    FontSize $FONT_SIZE_SM
}

' definition of the Item eventstorming/Element/FacadeCommand
skinparam file<<FacadeCommand>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #779fae
}

!procedure FacadeCommand($id, $label="")
  EsEntity('file', 'FacadeCommand', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/Command
skinparam file<<Command>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #aec6cf
}

!procedure Command($id, $label="")
  EsEntity('file', 'Command', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/Result
skinparam file<<Result>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #cfcfc4
}

!procedure Result($id, $label="")
  EsEntity('file', 'Result', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/Event
skinparam file<<TransactionalEvent>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #ffb853
}

!procedure TransactionalEvent($id, $label="")
  EsEntity('file', 'TransactionalEvent', $id, $label)
!endprocedure

skinparam file<<Event>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #ffb853
}

!procedure Event($id, $label="")
  EsEntity('file', 'Event', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/DomainEvent
skinparam file<<DomainEvent>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #ffcb81
}

!procedure DomainEvent($id, $label="")
  EsEntity('file', 'DomainEvent', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/IntegrationEvent
skinparam file<<IntegrationEvent>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #ffdeaf
}

!procedure IntegrationEvent($id, $label="")
  EsEntity('file', 'IntegrationEvent', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/Query
skinparam file<<Query>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #62d862
}

!procedure Query($id, $label="")
  EsEntity('file', 'Query', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/ReadModel
skinparam file<<ReadModel>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #77dd77
}

!procedure ReadModel($id, $label="")
  EsEntity('file', 'ReadModel', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/UserInterface
skinparam file<<UserInterface>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #a2e8a2
}

!procedure UserInterface($id, $label="")
  EsEntity('file', 'UserInterface', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/Aggregate
skinparam file<<Aggregate>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #fdfd9d
}

!procedure Aggregate($id, $label="")
  EsEntity('file', 'Aggregate', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/Service
skinparam file<<Service>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #fcfc78
}

!procedure Service($id, $label="")
  EsEntity('file', 'Service', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/Policy
skinparam file<<Policy>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #b6a2db
}

!procedure Policy($id, $label="")
  EsEntity('file', 'Policy', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/Saga
skinparam file<<Saga>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #c9bbe5
}

!procedure Saga($id, $label="")
  EsEntity('file', 'Saga', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/Process
skinparam file<<Process>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #ddd4ee
}

!procedure Process($id, $label="")
  EsEntity('file', 'Process', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/Timer
skinparam file<<Timer>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #cfcfc4
}

!procedure Timer($id, $label="")
  EsEntity('file', 'Timer', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/Person
skinparam actor<<Person>> {
    StereotypeFontSize 0
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #ffd1dc
}

!procedure Person($id, $label="")
  EsEntity('actor', 'Person', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/System
skinparam file<<System>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #ffd1dc
}

!procedure System($id, $label="")
  EsEntity('file', 'System', $id, $label)
!endprocedure

' definition of the Item eventstorming/Element/Comment
skinparam file<<Comment>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor transparent
}

!procedure Comment($id, $label="")
  EsEntity('file', 'Comment', $id, $label)
!endprocedure

skinparam rectangle<<Handler>> {
    StereotypeFontSize $FONT_SIZE_SM
    shadowing false
    FontColor $FONT_COLOR
    BorderColor $FONT_COLOR
    BackgroundColor #e8f4fd
}

!procedure Handler($id, $label="")
  EsEntity('file', 'Handler', $id, $label)
!endprocedure